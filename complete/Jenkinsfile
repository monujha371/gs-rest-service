
pipeline {
  agent any

  environment {
    AWS_REGION = "ap-south-1"
    ECR_REPO   = "devops-java-app"
    ACCOUNT_ID = "017789174175"
    IMAGE_TAG  = "1.0"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        script {
          def repoUrl   = sh(script: 'git remote get-url origin', returnStdout: true).trim()
          def commitSha = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
          echo "Repo: ${repoUrl}"
          echo "Commit: ${commitSha}"
        }
        sh 'ls -la'
      }
    }

    stage('Build & Test (Maven)') {
      steps {
        dir('complete') {
          // Use mvnw if present, otherwise system mvn
          sh '''
            set -e
            if [ -f mvnw ]; then
              chmod +x mvnw
              ./mvnw -B -v
              ./mvnw -B clean test
            else
              echo "mvnw not found; using system Maven"
              mvn -v
              mvn -B clean test
            fi
          '''
        }
      }
      post {
        always {
          junit testResults: 'complete/target/surefire-reports/*.xml', allowEmptyResults: true
        }
      }
    }

    stage('Package') {
      steps {
        dir('complete') {
          sh '''
            set -e
            if [ -f mvnw ]; then
              ./mvnw -B package -DskipTests
            else
              mvn -B package -DskipTests
            fi
          '''
        }
      }
      post {
        success {
          archiveArtifacts artifacts: 'complete/target/*.jar', fingerprint: true
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('complete') {
          script {
            // Find the built JAR (no shell $() used)
            def jar = sh(script: 'ls target/*.jar 2>/dev/null | head -n 1', returnStdout: true).trim()
            if (!jar) {
              error "No JAR found in complete/target/. Ensure Maven packaging produced a jar."
            }
            echo "Found JAR: ${jar}"

            // Compute basename in Groovy to avoid shell substitutions entirely
            def appJarName = sh(script: "basename ${jar}", returnStdout: true).trim()

            // Build the Docker image
            sh "docker build --build-arg APP_JAR=${appJarName} -t ${env.ECR_REPO}:${env.IMAGE_TAG} ."
          }
        }
      }
    }

    stage('Login to ECR') {
      steps {
        // Uses Groovy interpolation; no shell $ variables inside strings
        sh "aws ecr get-login-password --region ${env.AWS_REGION} | docker login --username AWS --password-stdin ${env.ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com"
      }
    }

    stage('Tag & Push Image') {
      steps {
        sh "docker tag ${env.ECR_REPO}:${env.IMAGE_TAG} ${env.ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/${env.ECR_REPO}:${env.IMAGE_TAG}"
        sh "docker push ${env.ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/${env.ECR_REPO}:${env.IMAGE_TAG}"
      }
    }
  }

  post {
    always {
      sh 'docker image prune -f || true'
      archiveArtifacts artifacts: 'complete/target/*.jar', allowEmptyArchive: true
      cleanWs()
    }
  }
}

